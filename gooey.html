
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		
		<!-- Google fonts -->
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:300' rel='stylesheet' type='text/css'>
		<link href='https://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
	
		<style>
			body {
				margin: 0;
			}
		</style>
	
		
		<!-- D3.js -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

	</head>	
	<body>
		<div id="chart"></div>
		
		<script src="populations.js"></script>

		<script language="javascript" type="text/javascript">

			///////////////////////////////////////////////////////////////////////////
			//////////////////// Set up and initiate svg containers ///////////////////
			///////////////////////////////////////////////////////////////////////////	

			var margin  = {
				top: 0,
				right: 0,
				bottom: 0,
				left: 0
			};
			var width = window.innerWidth - margin.left - margin.right,
				height = window.innerHeight - margin.top - margin.bottom;
						
			//SVG container
			var svg = d3.select('#chart')
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + (margin.left) + "," + (margin.top) + ")");

			///////////////////////////////////////////////////////////////////////////
			///////////////////////////// Create filter ///////////////////////////////
			///////////////////////////////////////////////////////////////////////////	

			//SVG filter for the gooey effect
			//Code taken from http://tympanus.net/codrops/2015/03/10/creative-gooey-effects/
			var defs = svg.append("defs");
			var filter = defs.append("filter").attr("id","gooeyCodeFilter");
			filter.append("feGaussianBlur")
				.attr("in","SourceGraphic")
				.attr("stdDeviation","10")
				//to fix safari: http://stackoverflow.com/questions/24295043/svg-gaussian-blur-in-safari-unexpectedly-lightens-image
				.attr("color-interpolation-filters","sRGB") 
				.attr("result","blur");
			filter.append("feColorMatrix")
				.attr("class", "blurValues")
				.attr("in","blur")
				.attr("mode","matrix")
				.attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -5")
				.attr("result","gooey");
			filter.append("feBlend")
				.attr("in","SourceGraphic")
				.attr("in2","gooey")
				.attr("operator","atop");

		 	///////////////////////////////////////////////////////////////////////////
			//////////////////////////////// Blobs ///////////////////////////////////
			/////////////////////////////////////////////////////////////////////////// 

            var centerx = window.innerWidth / 2;
            var centery = window.innerHeight / 2;

            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++ ) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            var randocolor = getRandomColor();

            //Radius scale

			var rScale = d3.scale.sqrt()
				.range([0,34])
				.domain([0, d3.max(populations, function(d) { return d.population; })]);

			// Wrapper
			var cityWrapper = svg.append("g")
				.attr("class", "cityWrapper")
				.style("filter", "url(#gooeyCodeFilter)")
                .attr("fill", randocolor );
				
			//Place the blobs
			var blobs = cityWrapper.selectAll(".blobs")
				.data(populations)
				.enter().append("circle")
				.attr("class", "blobs")
				.attr("r", function(d) { return d.radius ;})
				.attr("cx", centerx)
				.attr("cy", centery)
				.style("opacity", 1)
                .attr("fill", randocolor );

			var coverCircleRadius = 100;
			//Circle over all others
			cityWrapper.append("circle")
				.attr("class", "blobCover")
				.attr("r", coverCircleRadius)
				.attr("cx", centerx)
				.attr("cy", centery);
																		

			///////////////////////////////////////////////////////////////////////////
			///////////////////////////// Do the loop /////////////////////////////////
			///////////////////////////////////////////////////////////////////////////	
					
			loop();	
			setInterval(loop, 12000);
			
			function loop() {
				placeBlobs();
				// setTimeout(clusterCountry, 7000);
				setTimeout(backToCenter, 6000);
			}
						
			///////////////////////////////////////////////////////////////////////////
			/////////////////////////// Animation steps ///////////////////////////////
			///////////////////////////////////////////////////////////////////////////	
					
			//Move the blobs from the center to their actual locations
			function placeBlobs () {

				//Make the cover circle shrink
				d3.selectAll(".blobCover")
						.transition().duration(5000)
						.attr("r", 0);

				// place blobs
				d3.selectAll(".blobs")
					.transition("move").duration(2000)
					// .delay(function(d,i) { return i*20; })
					.attr("r", function(d) {
						return d.radius = rScale(d.population);
					})
					.attr("cx", function(d) {
						return d.x = Math.floor((Math.random() * window.innerWidth) + 1);
					})
					.attr("cy", function(d) {
						return d.y = Math.floor((Math.random() * window.innerHeight) + 1);
					});


				//"Remove" gooey filter during the transition
				//So at the end they do not appear to melt together anymore
				d3.selectAll(".blurValues")
					.transition().duration(4000)
					.attrTween("values", function() { 
						return d3.interpolateString("1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -5", 
													"1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 6 -5"); 
					});

			}

			//Move the circles back to the center location again
			function backToCenter () {

				//Hide labels
				d3.selectAll(".label")
					.transition().duration(500)
					.style("opacity", 0);

				//Show map
				// d3.selectAll(".geo-path")
				// 	.transition().duration(1000)
				// 	.style("fill-opacity", 0.5);
				
			   	//Make the cover cirlce to its true size again
			    d3.selectAll(".blobCover")
					.transition().duration(3000).delay(500)
					.attr("r", coverCircleRadius);

			    //Move the blobs to the center
				d3.selectAll(".blobs")
					.transition()
					.duration(2000).delay(function(d,i) { return i*10; })
					.attr("cx", centerx)
					.attr("cy", centery)
					.style("opacity", 1);
					
				d3.selectAll(".blurValues")
					.transition().duration(1000).delay(1000)
					.attrTween("values", function() {
						return d3.interpolateString("1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 35 -6",
													"1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -5");
					});

			}
																	
		</script>

	</body>
</html>